【基本設計書】Kotobuku AutoNotify																									
作成日：2026/02/06																									
作成者：四戸 珠江																									
対象：デモ環境（Google Apps Script + Googleスプレッドシート + Gmail）																									
																									
//////////////////////////////////////////////////////////////																									
1. システム概要																									
//////////////////////////////////////////////////////////////																									
スプレッドシート上のデータを監視し、条件に合致する行を抽出してメール通知する。																									
送信済み制御により重複送信を防止する。																									
																									
------------------------------------------------------------																									
1-1. 構成																									
------------------------------------------------------------																									
・Google Spreadsheet：通知データの管理																									
・Google Apps Script（GAS）：判定/本文生成/送信/送信済み制御																									
・Gmail：メール送信																									
																									
------------------------------------------------------------																									
1-2. ソース構成（ファイル責務）																									
------------------------------------------------------------																									
ファイル名                 | 役割（責務）																									
--------------------------|-----------------------------------------																									
demo20_lib.gs              | 共通関数（文字列整形、シート取得、ヘッダー検証等）																									
demo20_mailer.gs           | メール生成・送信（宛先/件名/本文の組み立てと送信）																									
send_control_core.gs       | メイン制御（対象抽出→送信→送信済み反映）																									
reset.gs                   | デモ用リセット（送信済みフラグ等の初期化）																									
																									
※命名は現状のリポジトリに合わせた。関数名は実装により微調整する可能性あり。																									
																									
//////////////////////////////////////////////////////////////																									
2. 画面/データ設計（シート設計）																									
//////////////////////////////////////////////////////////////																									
本デモは「通知対象一覧シート（入力）」と「送信制御列（状態管理）」を前提とする。																									
																									
------------------------------------------------------------																									
2-1. シート一覧																									
------------------------------------------------------------																									
シート名（例） | 用途																									
--------------|-----------------------------------------------																									
（入力シート）  | 通知対象データが入る（案件/顧客/ステータス等）																									
（ログ/補助）   | 任意（運用確認用。デモでは必須ではない）																									
																									
※実際のシート名は環境に合わせる（例：申請一覧、進捗、DEMO20 など）																									
																									
------------------------------------------------------------																									
2-2. 入力シート：ヘッダー定義（例）																									
------------------------------------------------------------																									
列名（ヘッダー）     | 型     | 必須 | 用途/意味																									
--------------------|--------|------|-------------------------																									
ID                   | 文字   | 〇   | 行の識別子（ユニーク推奨）																									
宛先メール           | 文字   | 〇   | 通知先メールアドレス																									
件名                 | 文字   | 〇   | メール件名（テンプレ可）																									
本文要素（任意）      | 文字   | △   | 本文に差し込む情報（顧客名/案件名等）																									
ステータス            | 文字   | 〇   | 判定用（例：送信対象/保留/完了）																									
送信対象フラグ        | 真偽/文字 | 〇 | TRUE/1/YES 等（判定ルールに合わせる）																									
送信済みフラグ        | 真偽/文字 | 〇 | 送信済みの状態管理																									
送信日時              | 日時   | △   | 送信実行時に書き込み																									
																									
※列名はサンプル。実際は現場シートの列に合わせて確定する。																									
※重要なのは「送信対象判定に使う列」と「送信済みを書き戻す列」があること。																									
																									
//////////////////////////////////////////////////////////////																									
3. 処理設計（データフロー）																									
//////////////////////////////////////////////////////////////																									
																									
------------------------------------------------------------																									
3-1. 全体フロー（概要）																									
------------------------------------------------------------																									
(1) シート取得																									
(2) ヘッダー存在チェック																									
(3) 対象行スキャン																									
(4) 送信対象の抽出（送信対象=ON かつ 送信済み=OFF 等）																									
(5) メール本文生成																									
(6) メール送信																									
(7) 送信済みフラグ/送信日時をシートへ反映																									
(8) 終了																									
																									
------------------------------------------------------------																									
3-2. フロー別：入出力対応表																									
------------------------------------------------------------																									
処理              | 入力（どこから）                 | 主担当ファイル           | 出力（どこへ）																									
------------------|----------------------------------|--------------------------|----------------------------																									
シート取得          | Spreadsheet / シート名           | demo20_lib.gs            | Sheetオブジェクト																									
ヘッダー検証        | 1行目（ヘッダー行）              | demo20_lib.gs            | OK/NG（NGはエラー）																									
対象行スキャン      | 2行目以降のデータ                | send_control_core.gs     | 対象候補の配列																									
送信対象抽出        | 送信対象フラグ/送信済みフラグ等   | send_control_core.gs     | 送信キュー（行情報）																									
本文生成            | 行データ（差し込み要素）          | demo20_mailer.gs         | subject/body																									
メール送信          | 宛先/件名/本文                    | demo20_mailer.gs         | Gmail送信結果																									
送信済み反映        | 対象行の行番号/状態列              | send_control_core.gs     | 送信済み=true、送信日時=now																									
リセット（任意）    | 対象範囲（全行/指定条件）          | reset.gs                 | 送信済み=false、送信日時クリア																									
																									
------------------------------------------------------------																									
3-3. 送信対象判定ルール（例）																									
------------------------------------------------------------																									
送信対象 = TRUE（または "1" / "YES"）																									
かつ																									
送信済み = FALSE（または 空欄 / "0"）																									
かつ																									
宛先メール が空でない																									
																									
※判定ルールはデモ要件に合わせて変更可能。																									
																									
//////////////////////////////////////////////////////////////																									
4. 関数/モジュール設計（呼び出し関係）																									
//////////////////////////////////////////////////////////////																									
※関数名は例。実際の実装名に合わせて置換する。																									
																									
------------------------------------------------------------																									
4-1. 共通（demo20_lib.gs）																									
------------------------------------------------------------																									
関数名（例）                 | 入力                    | 出力               | 用途																									
----------------------------|-------------------------|--------------------|-------------------------																									
_normHeader(v)               | 文字列                  | 正規化文字列        | ヘッダー正規化（空白除去等）																									
_getSheetOrThrow(ss, name)   | ss, シート名            | Sheet              | シート取得（無ければ例外）																									
_loadSheetByHeaderFlex(...)  | ss, sheetName, 必須列等 | ヘッダー/列Index等  | ヘッダー検証・列位置特定																									
																									
------------------------------------------------------------																									
4-2. メール（demo20_mailer.gs）																									
------------------------------------------------------------																									
関数名（例）                 | 入力                | 出力            | 用途																									
----------------------------|---------------------|-----------------|-------------------------																									
buildMail(row)               | 行データ            | {to,sub,body}   | 件名/本文組み立て																									
sendMail(to, sub, body)      | 宛先/件名/本文      | result          | Gmail送信																									
																									
------------------------------------------------------------																									
4-3. 制御（send_control_core.gs）																									
------------------------------------------------------------																									
関数名（例）                 | 入力              | 出力           | 用途																									
----------------------------|-------------------|----------------|-------------------------																									
main()                        | なし              | なし            | 全体オーケストレーション																									
scanTargets(sheet, colMap)    | sheet,列情報      | 対象配列         | 送信対象抽出																									
markSent(sheet, rowNo)        | sheet,行番号      | なし            | 送信済み反映																									
																									
------------------------------------------------------------																									
4-4. リセット（reset.gs）																									
------------------------------------------------------------																									
関数名（例）                 | 入力              | 出力           | 用途																									
----------------------------|-------------------|----------------|-------------------------																									
resetSentFlags()              | なし/条件         | なし            | 送信済み状態の初期化																									
																									
//////////////////////////////////////////////////////////////																									
5. エラー/例外設計（最低限）																									
//////////////////////////////////////////////////////////////																									
ケース                         | 挙動																									
------------------------------|--------------------------------------																									
必須ヘッダーが存在しない         | 処理中断（例外）、ログに理由																									
宛先メールが空の行が対象になった | 対象除外（またはエラーとして記録）																									
Gmail送信に失敗                 | 当該行は送信済みにしない（再送可能にする）																									
																									
//////////////////////////////////////////////////////////////																									
6. 運用（デモ想定）																									
//////////////////////////////////////////////////////////////																									
・初回：リセット → シートにデモデータ投入 → main() 実行 → 送信確認																									
・再実行：送信済みフラグにより重複送信しない																									
・再送したい場合：resetSentFlags() で送信済みを戻す																									
																									
以上																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
																									
